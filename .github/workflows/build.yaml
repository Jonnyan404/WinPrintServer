name: Build WinPrintServer

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    # å…ˆç¼–è¯‘ DLL
    - name: Build DLL Release x64
      run: |
        msbuild WinPrintServer.sln /p:Configuration=Release /p:Platform=x64

    - name: Build DLL Release x86
      run: |
        msbuild WinPrintServer.sln /p:Configuration=Release /p:Platform=x86

    # ç›´æ¥ç¼–è¯‘ UI é¡¹ç›®æ–‡ä»¶ï¼ˆä¸æ˜¯è§£å†³æ–¹æ¡ˆæ–‡ä»¶ï¼‰
    - name: Build UI Release x64
      run: |
        msbuild WinPrintServerUI/WinPrintServerUI/WinPrintServerUI.csproj /p:Configuration=Release /p:Platform=x64

    - name: Build UI Release x86
      run: |
        msbuild WinPrintServerUI/WinPrintServerUI/WinPrintServerUI.csproj /p:Configuration=Release /p:Platform=x86

    - name: Create release packages
      shell: pwsh
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path ./release-x64
        New-Item -ItemType Directory -Force -Path ./release-x86
        
        # å¤åˆ¶ x64 æ–‡ä»¶ï¼ˆUI å·²ç»åŒ…å«äº† DLLï¼‰
        Copy-Item -Path "x64/Release/WinPrintServer.exe" -Destination "./release-x64/"
        Copy-Item -Path "WinPrintServerUI/WinPrintServerUI/bin/x64/Release/*" -Destination "./release-x64/" -Recurse
        
        # å¤åˆ¶ x86 æ–‡ä»¶ï¼ˆUI å·²ç»åŒ…å«äº† DLLï¼‰
        Copy-Item -Path "Release/WinPrintServer32.exe" -Destination "./release-x86/"
        Copy-Item -Path "WinPrintServerUI/WinPrintServerUI/bin/x86/Release/*" -Destination "./release-x86/" -Recurse
        
        # åˆ›å»º README
        @"
        WinPrintServer ${{ github.ref_name }}
        
        ğŸ“¦ This package contains:
        - WinPrintServerUI.exe: ğŸ–¥ï¸ Graphical user interface (RECOMMENDED)
        - WinPrintServer.exe: ğŸ’» Command-line print server
        
        ğŸš€ Quick Start:
        Just run WinPrintServerUI.exe - all dependencies included!
        
        âœ¨ Features:
        - Multi-instance support: Run multiple servers on different ports
        - Real-time logging with filtering
        - Easy printer selection
        
        ğŸ“– For more information: https://github.com/${{ github.repository }}
        "@ | Out-File -FilePath "./release-x64/README.txt" -Encoding UTF8
        
        Copy-Item -Path "./release-x64/README.txt" -Destination "./release-x86/"
        
        # åˆ›å»ºå‹ç¼©åŒ…ï¼ˆå¸¦ç‰ˆæœ¬å·ï¼‰
        Compress-Archive -Path "./release-x64/*" -DestinationPath "WinPrintServer-${{ github.ref_name }}-x64.zip"
        Compress-Archive -Path "./release-x86/*" -DestinationPath "WinPrintServer-${{ github.ref_name }}-x86.zip"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: WinPrintServer-binaries
        path: |
          WinPrintServer-${{ github.ref_name }}-x64.zip
          WinPrintServer-${{ github.ref_name }}-x86.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: WinPrintServer-binaries
        path: ./artifacts

    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./artifacts/WinPrintServer-${{ github.ref_name }}-x64.zip
          ./artifacts/WinPrintServer-${{ github.ref_name }}-x86.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}